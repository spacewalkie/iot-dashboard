<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IoT Dashboard v2</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  
  <style>
    /* Dark Theme Setup */
    body {
      background-color: #121212;
      color: #e0e0e0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .glass-card {
      background: rgba(30, 30, 30, 0.6);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 20px;
      box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
    }
    .stat-card:hover { transform: translateY(-5px); transition: transform 0.3s ease; }
    .icon-box { font-size: 2.5rem; margin-bottom: 10px; }
    .temp-color { color: #ff6b6b; text-shadow: 0 0 15px rgba(255, 107, 107, 0.4); }
    .hum-color  { color: #4ecdc4; text-shadow: 0 0 15px rgba(78, 205, 196, 0.4); }
    .value-text { font-size: 3.5rem; font-weight: 700; margin: 0; }
    .unit { font-size: 1.5rem; font-weight: 400; opacity: 0.7; }
    .status-dot {
      height: 10px; width: 10px; background-color: #00ff00; border-radius: 50%;
      display: inline-block; box-shadow: 0 0 10px #00ff00; animation: pulse 2s infinite;
    }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(0, 255, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(0, 255, 0, 0); } }
  </style>
</head>
<body class="p-3 p-md-5">

  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-5">
      <h2 class="fw-bold"><i class="fas fa-satellite-dish me-2"></i> IoT Dashboard</h2>
      <div class="glass-card px-3 py-1">
        <span class="status-dot me-2"></span> <small>LIVE</small>
      </div>
    </div>

    <div class="row g-4 mb-4">
      <div class="col-md-6">
        <div class="glass-card stat-card p-4 text-center">
          <div class="icon-box temp-color"><i class="fas fa-temperature-high"></i></div>
          <h5 class="text-uppercase text-muted letter-spacing">Temperature</h5>
          <div class="value-text text-white">
            <span id="tempValue">--</span><span class="unit">Â°C</span>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="glass-card stat-card p-4 text-center">
          <div class="icon-box hum-color"><i class="fas fa-tint"></i></div>
          <h5 class="text-uppercase text-muted letter-spacing">Humidity</h5>
          <div class="value-text text-white">
            <span id="humValue">--</span><span class="unit">%</span>
          </div>
        </div>
      </div>
    </div>

    <div class="glass-card p-3 p-md-4">
      <h5 class="mb-4"><i class="fas fa-chart-line me-2"></i>20-Point History</h5>
      <canvas id="myChart" height="100"></canvas>
    </div>

    <div class="mt-4 p-3" style="background: #000; color: #0f0; font-family: monospace; border-radius: 10px; font-size: 12px;">
      <strong>SYSTEM LOG:</strong><br>
      <span id="debug-log">Waiting for Firebase connection...</span>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script type="module">
    // --- IMPORTING STABLE VERSION 10.13.1 ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getDatabase, ref, onValue, query, limitToLast } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    // --- YOUR CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyDzex6dSRjkE8PrlLS83teyACVm1-znxXo",
      authDomain: "weatherstation-857c2.firebaseapp.com",
      databaseURL: "https://weatherstation-857c2-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "weatherstation-857c2",
      storageBucket: "weatherstation-857c2.firebasestorage.app",
      messagingSenderId: "794617552534",
      appId: "1:794617552534:web:05b4fe5d8453b659b6ecb7",
      measurementId: "G-SG64WXJPV0"
    };

    // Helper to print logs to the black box on screen
    function log(msg) {
        const logBox = document.getElementById('debug-log');
        logBox.innerHTML += "<br>> " + msg;
        console.log(msg);
    }

    try {
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        log("Firebase initialized successfully.");

        // --- CHART SETUP ---
        const ctx = document.getElementById('myChart').getContext('2d');
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(255, 107, 107, 0.5)');
        gradient.addColorStop(1, 'rgba(255, 107, 107, 0)');

        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temperature',
                    data: [],
                    borderColor: '#ff6b6b',
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#ff6b6b',
                    pointRadius: 4,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    x: { display: false }, 
                    y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#aaa' } }
                }
            }
        });

        // --- 1. LISTENING TO LIVE SENSORS (For Big Numbers) ---
        const sensorsRef = ref(db, 'sensors');
        onValue(sensorsRef, (snapshot) => {
          const data = snapshot.val();
          if(data) {
            document.getElementById('tempValue').innerText = data.temperature;
            document.getElementById('humValue').innerText = data.humidity;
            log("Received Live Update: " + data.temperature + "C");
          } else {
            log("Connected, but 'sensors' node is empty.");
          }
        }, (error) => {
            log("ERROR reading /sensors: " + error.message);
        });

        // --- 2. LISTENING TO HISTORY (For Graph) ---
        log("Attempting to read last 20 history points...");
        const historyRef = query(ref(db, 'history'), limitToLast(20));
        
        onValue(historyRef, (snapshot) => {
          if (!snapshot.exists()) {
             log("History node is empty. Wait for NodeMCU to send data.");
             return;
          }

          // Clear chart data
          myChart.data.labels = [];
          myChart.data.datasets[0].data = [];
          
          let count = 0;
          snapshot.forEach((childSnapshot) => {
             const entry = childSnapshot.val();
             if (entry.temperature) {
                 // Add to graph
                 myChart.data.labels.push(""); 
                 myChart.data.datasets[0].data.push(entry.temperature);
                 count++;
             }
          });
          
          myChart.update();
          log("Graph updated with " + count + " history points.");
        }, (error) => {
             log("ERROR reading /history: " + error.message);
        });

    } catch (e) {
        log("CRITICAL ERROR: " + e.message);
    }
  </script>
</body>
</html>
